
using Test: @test, @testset
# provides functions for test below to keep this script concise
include(joinpath(@__DIR__,"ImplicitCollisionsTest.jl"))

expected_chebyshev = pdf_and_grid( 
# Expected vpa
[-4.000000000000000, -3.333333333333333, -2.666666666666667, -2.000000000000000, -1.333333333333333, -0.666666666666667, 0.000000000000000, 0.666666666666667, 1.333333333333333, 2.000000000000000, 2.666666666666667, 3.333333333333333, 4.000000000000000],
# Expected vperp
[0.127322003750035, 0.872677996249965, 1.333333333333333, 2.000000000000000, 2.666666666666667, 3.333333333333333, 4.000000000000000],
# Expected Fout
[0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000001 0.000000000000010 0.000000000000007 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000223764 0.000000004411696 0.000000003018193 0.000000000086216 0.000000000000070 0.000000000000000 0.000000000000000 ;
0.000002765723407 0.000054528647228 0.000037304923934 0.000001065633834 0.000000000869544 0.000000000000020 0.000000000000000 ;
0.000976494284691 0.019252435812943 0.013171253828169 0.000376243461562 0.000000307010088 0.000000000007156 0.000000000000000 ;
0.009848554858798 0.194172841809591 0.132840322692654 0.003794650342097 0.000003096388518 0.000000000072174 0.000000000000000 ;
0.002837377712984 0.055941374314942 0.038271419147044 0.001093242253671 0.000000892072380 0.000000000020793 0.000000000000000 ;
0.000023350900860 0.000460383360187 0.000314964098787 0.000008997107211 0.000000007341530 0.000000000000171 0.000000000000000 ;
0.000000005489490 0.000000108230072 0.000000074043917 0.000000002115102 0.000000000001726 0.000000000000000 0.000000000000000 ;
0.000000000000037 0.000000000000727 0.000000000000497 0.000000000000014 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
0.000297309833614 0.000226041823076 0.000152143634974 0.000050997339902 -0.000005664172728 -0.000003375489271 0.000006562866859 ;
-0.000235519884244 -0.000186395625897 -0.000124421573406 -0.000029514826931 0.000015111210813 0.000002557832207 -0.000003797111485 ;
0.001870116757988 0.001034465528857 0.000393393164783 -0.000028394997505 -0.000016237933696 0.000019286855240 -0.000001022855301 ;
-0.001126525228781 -0.000731612004179 -0.000255953886978 0.000137289241506 0.000012058707331 -0.000038608484215 0.000096334063383 ;
0.011064756723531 0.003176701156031 -0.000708972673038 -0.000424099437423 0.000607551880540 -0.000187057156942 0.000262700254659 ;
0.118300328413565 0.051715582425901 0.012647983316918 -0.000732048748190 0.002025152370248 -0.000331379576947 0.000420540552815 ;
0.224449224223809 0.099713579532718 0.026526996106208 -0.000541459994106 0.003079320175091 -0.000401467504517 0.000504336781700 ;
0.173470708774796 0.076158355672588 0.019313388399501 -0.000752601444667 0.002640312741349 -0.000388534469232 0.000488037837742 ;
0.041136762551275 0.015949232802171 0.002105009989804 -0.000719792083445 0.001160959449175 -0.000275625562554 0.000362866519856 ;
0.000074506117307 -0.000646307913463 -0.000593936878455 0.000079253643366 0.000148451941041 -0.000089571857053 0.000162548022848 ;
0.004415892923097 0.002524070970606 0.001126137750039 0.000119524288638 -0.000043261239279 0.000020162260004 0.000016722545637 ;
-0.000419500329671 -0.000342252634551 -0.000246202222563 -0.000082179592320 0.000018995475540 0.000009836521746 -0.000005667096666 ;
0.000596384925964 0.000444767269378 0.000311177941230 0.000135314573420 0.000010088106241 -0.000006513112995 0.000007566148981 ])

expected_gausslegendre = pdf_and_grid(
    # Expected vpa
[-4.000000000000000, -3.333333333333333, -2.666666666666667, -2.000000000000000, -1.333333333333333, -0.666666666666667, 0.000000000000000, 0.666666666666667, 1.333333333333333, 2.000000000000000, 2.666666666666667, 3.333333333333333, 4.000000000000000],
# Expected vperp
[0.206734700962243, 0.859931965704424, 1.333333333333333, 2.000000000000000, 2.666666666666667, 3.333333333333333, 4.000000000000000],
# Expected Fout
[0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000001 0.000000000000011 0.000000000000008 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000410104 0.000000004698570 0.000000003258575 0.000000000093083 0.000000000000076 0.000000000000000 0.000000000000000 ;
0.000005068891362 0.000058074417543 0.000040276050895 0.000001150505563 0.000000000938799 0.000000000000022 0.000000000000000 ;
0.001789674062350 0.020504341350202 0.014220269969410 0.000406209132968 0.000000331461711 0.000000000007726 0.000000000000000 ;
0.018049980894667 0.206799091194791 0.143420305777807 0.004096872857216 0.000003342998413 0.000000000077922 0.000000000000000 ;
0.005200216097143 0.059579008375755 0.041319522004768 0.001180312838244 0.000000963120918 0.000000000022449 0.000000000000000 ;
0.000042796463080 0.000490320168364 0.000340049214286 0.000009713676097 0.000000007926242 0.000000000000185 0.000000000000000 ;
0.000000010060886 0.000000115267822 0.000000079941097 0.000000002283557 0.000000000001863 0.000000000000000 0.000000000000000 ;
0.000000000000068 0.000000000000774 0.000000000000537 0.000000000000015 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
0.000281208372995 0.000227289633421 0.000163474247695 0.000066282479363 0.000000924822983 -0.000003911314735 0.000006184093189 ;
-0.000215911829089 -0.000181970448885 -0.000129726379222 -0.000037498318183 0.000014732435329 0.000004793087715 -0.000004379035052 ;
0.001902241126869 0.001178004865103 0.000512484354857 0.000024074827011 -0.000017096141486 0.000019584442725 0.000004359569546 ;
-0.000763954912816 -0.000632177872445 -0.000308101405136 0.000089436436348 0.000041093001242 -0.000036748648778 0.000097569647614 ;
0.013343468299580 0.005438883040728 0.000266349156290 -0.000389609332101 0.000613490296068 -0.000163268976667 0.000239567193979 ;
0.102846309039834 0.051604683790421 0.014396768202992 -0.000173890969566 0.001851154291280 -0.000272622581688 0.000362756701578 ;
0.186906429276164 0.094964513854263 0.028156274512757 0.000422656408465 0.002752334416277 -0.000322484748792 0.000427930965762 ;
0.146462202506693 0.073751141857138 0.021111133214882 0.000026163979501 0.002376565967712 -0.000314970124230 0.000416152011755 ;
0.039776982854698 0.018480442351828 0.003718337942028 -0.000507416368369 0.001106509811587 -0.000233035055818 0.000321301248664 ;
0.001468856461949 0.000192288743183 -0.000356200754164 0.000026312397355 0.000182949026958 -0.000080221513064 0.000155336519974 ;
0.003626164555680 0.002256949591536 0.001054788292827 0.000151995671911 -0.000031742656945 0.000018388367363 0.000024252909417 ;
-0.000303300013449 -0.000261811124077 -0.000197604550660 -0.000071284176517 0.000016622540671 0.000012113358582 -0.000004542943230 ;
0.000464439111991 0.000363786705846 0.000262924265946 0.000124265223134 0.000016718756805 -0.000005518679857 0.000004410223206 ]) 

atol = 1.0e-13
@testset "Implicit collisions demo script" begin
    println("Test implicit collisions demo script")
    @testset "Gauss Legendre" begin
        println("    - test Gauss Legendre")
        output_pdf_and_grid = test_implicit_collisions(test_particle_preconditioner=true,test_numerical_conserving_terms=true,
           vth0=0.5,vperp0=1.0,vpa0=0.1, nelement_vpa=6,nelement_vperp=3,Lvpa=8.0,Lvperp=4.0, bc_vpa="none", bc_vperp="none",
            ntime=50, delta_t = 1.0, ngrid=3, test_linearised_advance=false, print_diagnostics=false, print_timing=false,
            test_external_chebyshev_grid=false, continuous_integration_test=true)
        @test isapprox(expected_gausslegendre.vpa_grid[:], output_pdf_and_grid.vpa_grid[:], atol=atol)
        @test isapprox(expected_gausslegendre.vperp_grid[:], output_pdf_and_grid.vperp_grid[:], atol=atol)
        for it in 1:2
            @test isapprox(expected_gausslegendre.pdf[:,:,it], output_pdf_and_grid.pdf[:,:,it], atol=atol)
        end
    end
    @testset "Gauss Chebyshev" begin
        println("    - test Gauss Chebyshev")
        output_pdf_and_grid = test_implicit_collisions(test_particle_preconditioner=true,test_numerical_conserving_terms=true,
           vth0=0.5,vperp0=1.0,vpa0=0.1, nelement_vpa=6,nelement_vperp=3,Lvpa=8.0,Lvperp=4.0, bc_vpa="none", bc_vperp="none",
            ntime=50, delta_t = 1.0, ngrid=3, test_linearised_advance=false, print_diagnostics=false, print_timing=false,
            test_external_chebyshev_grid=true, continuous_integration_test=true)
        @test isapprox(expected_chebyshev.vpa_grid[:], output_pdf_and_grid.vpa_grid[:], atol=atol)
        @test isapprox(expected_chebyshev.vperp_grid[:], output_pdf_and_grid.vperp_grid[:], atol=atol)
        for it in 1:2
            @test isapprox(expected_chebyshev.pdf[:,:,it], output_pdf_and_grid.pdf[:,:,it], atol=atol)
        end
    end
    
end